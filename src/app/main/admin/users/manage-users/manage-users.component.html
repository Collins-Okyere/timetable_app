<div class="mt-16 p-4 space-y-6 bg-gray-50 min-h-screen">

  <!-- Page Title -->
  <div class="flex items-center justify-between">
    <div class="py-2 font-bold text-xl">Manage Users</div>
    <button (click)="openAddUser()" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700"> + Add User </button>
  </div>

  <!-- Stats -->
  <div class="{{hideStats ? 'hidden lg:grid md:grid-cols-3' : 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3'}} gap-4">
    
    <div class="bg-white shadow rounded-xl p-4 flex flex-row lg:flex-col justify-between">
      <p class="text-gray-500 text-sm">Total users</p>
      <h2 class="text-2xl font-bold">{{ getStats.totalUsers }}</h2>
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-row lg:flex-col justify-between">
      <p class="text-gray-500 text-sm">Male</p>
      <h2 class="text-2xl font-bold">{{ getStats.maleUsers }}</h2>
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-row lg:flex-col justify-between">
      <p class="text-gray-500 text-sm">Female</p>
      <h2 class="text-2xl font-bold">{{ getStats.femaleUsers }}</h2>
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-row lg:flex-col justify-between">
      <p class="text-gray-500 text-sm">Active Users</p>
      <h2 class="text-2xl font-bold">{{ getStats.activeUsers }}</h2>
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-row lg:flex-col justify-between">
      <p class="text-gray-500 text-sm">New users</p>
      <h2 class="text-2xl font-bold">{{ getStats.newUsers }}</h2>
    </div>


  </div>

  <div (click)="hideStats = !hideStats" class="flex flex-row lg:hidden justify-end p-2 hover:text-emerald-600 bg-gray-50 shadow">{{hideStats ? 'View Stats' : 'Hide Stats'}}</div>


  <!-- User list -->
  <div class="bg-white shadow rounded-xl px-2 py-4 lg:p-4">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
      
      <h3 class="font-semibold text-lg">User list
        <span class="text-gray-500 text-sm">{{ getStats.totalUsers }} users</span>
      </h3>

      <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
        <div class="relative flex-1">
          <input type="text" [(ngModel)]="search" placeholder="Search for user" class="pl-10 placeholder:text-sm appearance-none min-w-0 w-full bg-white border border-slate-300 rounded-md shadow-sm py-2 {{modalMode !=='view' ? 'px-4' : '' }} text-base text-slate-900 placeholder-slate-500 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500" />
          <svg class="w-5 h-5 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M16.65 10.5a6.15 6.15 0 11-12.3 0 6.15 6.15 0 0112.3 0z" />
          </svg>
        </div>
      </div>

    </div>

    <!-- Table -->
    <div class="overflow-x-auto hidden lg:block">

      <table class="min-w-full border-t">

        <thead class="bg-gray-100 text-gray-600 text-sm uppercase">
          <tr>
            <th class="p-2 lg:px-4 lg:py-3 text-left">S/N</th>
            <th class="px-4 py-3 text-left">User</th>
            <th class="px-4 py-3 text-left">Email</th>
            <th class="px-4 py-3 text-left">Role</th>
            <th class="px-4 py-3 text-right">Actions</th>
          </tr>
        </thead>

        <tbody class="text-gray-700">

          <tr *ngFor="let user of filteredUsers; let i = index;" class="border-t hover:bg-gray-50">
            
            <td class="p-2 lg:px-4 lg:py-3 font-bold">{{ i+1 }}.</td>
            
            <td class="px-4 py-3 flex items-center space-x-2">
              <img [src]="user.photo" alt="user" class="w-8 h-8 rounded-full" />
              <span>{{ user.first_name }} {{ user.last_name }}</span>
            </td>
            
            <td class="px-4 py-3">{{ user.email }}</td>
            
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded text-xs" [ngClass]="{ 'bg-green-100 text-green-700': user.user_role === 'super_admin', 'bg-emerald-100 text-emerald-700': user.user_role === 'admin', 'bg-gray-100 text-gray-700': user.user_role !== 'super_admin' && user.user_role !== 'admin' }">{{ user.user_role }}</span>
            </td>
            
            <td class="px-4 py-3 text-right relative">
              <div class="inline-block text-left">
                
                <button (click)="user.showMenu = !user.showMenu" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none">
                  <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zm6 0a2 2 0 11-4 0 2 2 0 014 0zm6 0a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                </button>
                
                <div *ngIf="user.showMenu" class="origin-top-right absolute right-0 mt-2 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50">
                  <div class="py-1 text-sm text-gray-700">
                    <button (click)="viewUser(user); user.showMenu=false" class="block w-full text-left px-4 py-2 hover:bg-gray-100">View</button>
                    <button (click)="editUser(user); user.showMenu=false" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Edit</button>
                    <button (click)="confirmDelete(user); user.showMenu=false" class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600">Delete</button>
                  </div>
                </div>

              </div>
            </td>

          </tr>

        </tbody>

      </table>

    </div>

    <div class="overflow-x-auto lg:hidden">

      <table class="min-w-full border-t">

        <thead class="bg-gray-100 text-gray-600 text-sm uppercase">
          <tr>
            <th class="p-2 lg:px-4 lg:py-3 text-left">S/N</th>
            <th class="px-4 py-3 text-left">User</th>
            <th class="px-4 py-3 text-right">Actions</th>
          </tr>
        </thead>

        <tbody class="text-gray-700">

          <tr *ngFor="let user of filteredUsers; let i = index;" class="border-t hover:bg-gray-50">
            
            <td class="p-2 lg:px-4 lg:py-3 font-bold">{{ i+1 }}.</td>
            
            <td class="px-4 py-3 flex items-center space-x-2">
              <img [src]="user.photo" alt="user" class="w-8 h-8 rounded-full" />
              <span>{{ user.first_name }} {{ user.last_name }}</span>
            </td>
            
            <td class="px-4 py-3 text-right relative">
              <div class="inline-block text-left">
                
                <button (click)="user.showMenu = !user.showMenu" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none">
                  <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zm6 0a2 2 0 11-4 0 2 2 0 014 0zm6 0a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                </button>
                
                <div *ngIf="user.showMenu" class="origin-top-right absolute right-0 mt-2 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50">
                  <div class="py-1 text-sm text-gray-700">
                    <button (click)="viewUser(user); user.showMenu=false" class="block w-full text-left px-4 py-2 hover:bg-gray-100">View</button>
                    <button (click)="editUser(user); user.showMenu=false" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Edit</button>
                    <button (click)="confirmDelete(user); user.showMenu=false" class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600">Delete</button>
                  </div>
                </div>

              </div>
            </td>

          </tr>

        </tbody>

      </table>

    </div>
  
    <!-- pagination -->
    <div class="mt-3 flex items-center justify-between">
    
      <div class="text-sm text-gray-600">Showing {{ (page-1)*pageSize + 1 }} â€” {{ Math.min(page*pageSize, filteredUsers.length)}} of {{ filteredUsers.length }}</div>
    
      <div class="flex items-center gap-2">
        <button (click)="prevPage()" [disabled]="page===1" class="px-3 py-1 rounded border disabled:opacity-50">Prev</button>
        <div class="px-3 py-1 bg-white border rounded">{{ page }} / {{ totalPages }}</div>
        <button (click)="nextPage()" [disabled]="page===totalPages" class="px-3 py-1 rounded border disabled:opacity-50">Next</button>
      </div>
    
    </div>

  </div>

</div>

<!-- Add/Edit/View Modal -->
<div *ngIf="showModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md md:max-w-lg p-6 mx-3">
    
    <h3 class="text-xl font-semibold mb-4">{{ modalMode === 'add' ? 'Add User' : modalMode === 'edit' ? 'Edit User' : 'View User' }}</h3>

    <div class="px-3 {{modalMode === 'view' ? 'lg:grid lg:grid-cols-2 lg:gap-4' : 'space-y-4 '}}">

      <div class="{{modalMode === 'view' ? 'lg:col-span-1' : ''}}">
        <label class="mb-1 text-sm text-gray-500">First Name</label>
        <input type="text" [(ngModel)]="selectedUser.first_name" placeholder="First Name" [disabled]="modalMode === 'view'" [class.border]="modalMode!=='view'" class="placeholder:text-sm appearance-none min-w-0 w-full bg-white border border-slate-300 rounded-md shadow-sm py-2 {{modalMode !=='view' ? 'px-4' : '' }} text-base text-slate-900 placeholder-slate-500 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500" />
      </div>

      <div class="{{modalMode === 'view' ? 'lg:col-span-1' : ''}}">
        <label class="mb-1 text-sm text-gray-500">Last Name</label>
        <input type="text" [(ngModel)]="selectedUser.last_name" placeholder="Last Name" [disabled]="modalMode === 'view'" [class.border]="modalMode!=='view'" class="placeholder:text-sm appearance-none min-w-0 w-full bg-white border border-slate-300 rounded-md shadow-sm py-2 {{modalMode !=='view' ? 'px-4' : '' }} text-base text-slate-900 placeholder-slate-500 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500" />
      </div>

      <div class="{{modalMode === 'view' ? 'lg:col-span-1' : ''}}">
        <label class="mb-1 text-sm text-gray-500">Email</label>
        <input type="email" [(ngModel)]="selectedUser.email" placeholder="Email" [disabled]="modalMode === 'view'" [class.border]="modalMode!=='view'" class="placeholder:text-sm appearance-none min-w-0 w-full bg-white border border-slate-300 rounded-md shadow-sm py-2 {{modalMode !=='view' ? 'px-4' : '' }} text-base text-slate-900 placeholder-slate-500 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500" />
      </div>

      <div class="{{modalMode === 'view' ? 'lg:col-span-1' : ''}}">
        <label class="mb-1 text-sm text-gray-500">Phone</label>
        <input type="text" [(ngModel)]="selectedUser.phone" placeholder="Phone" [disabled]="modalMode === 'view'" [class.border]="modalMode!=='view'" class="placeholder:text-sm appearance-none min-w-0 w-full bg-white border border-slate-300 rounded-md shadow-sm py-2 {{modalMode !=='view' ? 'px-4' : '' }} text-base text-slate-900 placeholder-slate-500 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500" />
      </div>

      <div class="{{modalMode === 'view' ? 'lg:col-span-1' : ''}}">
        <label class="mb-1 text-sm text-gray-500">Gender</label>
        <app-select-input *ngIf="refreshSelect" id="gender" [selectInputData]="{ items: ['Male', 'Female'], placeholder: 'Select Gender', displayProperty: 'name', searchProperty: 'name', defaultValue: selectedUser?.gender ?? 'Male', autoClose: true, disabled: modalMode === 'view', noOutline: modalMode === 'view' }"  (selectionChanged)="onSelectionChanged('gender', $event)"></app-select-input>
      </div>

      <div class="{{modalMode === 'view' ? 'lg:col-span-1' : ''}}">
        <label class="mb-1 text-sm text-gray-500">Role</label>
        <app-select-input *ngIf="refreshSelect" id="user_role" [selectInputData]="{ items: ['Admin', 'lecturer'], placeholder: 'Select User Role', displayProperty: 'name', searchProperty: 'name', defaultValue: selectedUser?.user_role ?? 'lecturer', autoClose: true, disabled: modalMode === 'view', noOutline: modalMode === 'view' }"  (selectionChanged)="onSelectionChanged('user_role', $event)"></app-select-input>
      </div>

      <div class="{{modalMode === 'view' ? 'lg:col-span-1' : ''}}">
        <label class="mb-1 text-sm text-gray-500">Country</label>
        <app-select-input *ngIf="refreshSelect" id="countries" [selectInputData]="{ items: fetchedData?.countries, placeholder: 'Select Country', displayProperty: 'name', searchProperty: 'name', defaultValue: selectedUser?.country ?? fetchedData.countries[0], autoClose: true, disabled: modalMode === 'view', noOutline: modalMode === 'view' }"  (selectionChanged)="onSelectionChanged('country', $event)"></app-select-input>
      </div>

    </div>

    <div class="flex justify-end space-x-2 mt-6 border-t pt-4">
      <button (click)="closeModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Close</button>
      <button *ngIf="modalMode==='view'" (click)="editUser(selectedUser)" class="px-6 py-2 rounded bg-yellow-600 text-white hover:bg-yellow-700">Edit</button>
      <button *ngIf="modalMode!=='view'" (click)="saveUser()" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">{{modalMode === 'add' ? 'Save' : 'Update'}}</button>
    </div>

  </div>

</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6 mx-3">
    
    <h3 class="text-lg font-semibold mb-4">Confirm Deletion</h3>
    
    <p class="mb-4 text-gray-600">Are you sure you want to delete <strong>{{ selectedUser?.first_name }} {{selectedUser?.last_name }}</strong>?</p>
    
    <div class="flex justify-end space-x-2">
      <button (click)="cancelDelete()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
      <button (click)="deleteUserConfirmed()" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Delete</button>
    </div>

  </div>
</div>