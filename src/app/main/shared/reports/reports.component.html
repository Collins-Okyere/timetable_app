<div class="p-4 lg:p-16 py-16 my-8 min-h-screen">
    <div class="w-full">

        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4 mx-3 lg:mx-0">
            <div>
                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">{{user?.user_role === 'lecturer' ? 'My' : ''}} Donations — Reports</h1>
                <p class="text-sm text-gray-700 mt-1">Overview of your donations and reports.</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl lg:p-4 lg:shadow">
            
            <div class="hidden lg:grid grid-cols-1 md:grid-cols-4 gap-3 my-6 mx-3 items-center">

                <div>
                    <label class="block text-xs text-gray-600 mb-1">From</label>
                    <input type="date" [(ngModel)]="filter.startDate" (ngModelChange)="onStartDateChange($event)" class="w-full p-2 border rounded-md" />
                </div>

                <div>
                    <label class="block text-xs text-gray-600 mb-1">To</label>
                    <input type="date" [(ngModel)]="filter.endDate" (ngModelChange)="onEndDateChange($event)" class="w-full p-2 border rounded-md" />
                </div>

                <div>
                    <label class="block text-xs text-gray-600 mb-1">Report On</label>
                    <app-select-input class="w-full" *ngIf="refreshSelect" id="tableData" [selectInputData]="{ items: ['All Donations','Beneficiaries', 'Organisations', 'Projects'], defaultValue: filter.tableData, placeholder: 'Filter By Organisation', autoClose: true }" (selectionChanged)="onFilter('tableData', $event)"></app-select-input>
                </div>

                <div *ngIf="filter?.tableData !== 'Projects'">
                    <label class="block text-xs text-gray-600 mb-1">Filter By Organisation</label>
                    <app-select-input class="w-full" *ngIf="refreshSelect" id="organisation" [selectInputData]="{ items: organisations, defaultValue: filter.organisation, placeholder: 'Filter By Organisation', autoClose: true }" (selectionChanged)="onFilter('organisation', $event)"></app-select-input>
                </div>

                <div *ngIf="filter?.tableData === 'Projects'">
                    <label class="block text-xs text-gray-600 mb-1">Filter By Project</label>
                    <app-select-input class="w-full" *ngIf="refreshSelect" id="projects" [selectInputData]="{ items: projects, defaultValue: filter.project, placeholder: 'Filter By Projects', autoClose: true }" (selectionChanged)="onFilter('project', $event)"></app-select-input>
                </div>

            </div>

            <!-- Summary cards -->
            <div *ngIf="showStats" class="mx-3 py-4 lg:py-8 grid grid-cols-1 sm:grid-cols-3 lg:gap-4 gap-y-2 border-b lg:border-y border-gray-200">
            
                <div class="bg-white p-4 rounded-xl shadow flex flex-row justify-between items-center lg:block">
                    <div class="text-sm text-gray-700">Total Donations</div>
                    <div class="mt-2 font-semibold text-lg lg:text-2xl text-gray-800">{{ totalDonationsCount }}</div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow flex flex-row justify-between items-center lg:block">
                    <div class="text-sm text-gray-700 whitespace-nowrap inline-flex">Total Cash <span class="lg:ml-1 hidden lg:block">Value</span></div>
                    <div class="mt-2 font-semibold text-lg lg:text-2xl text-gray-800">{{ formatCurrency(totalCash) }}</div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow flex flex-row justify-between items-center lg:block">
                    <div class="text-sm text-gray-700">In-Kind Donations</div>
                    <div class="mt-2 font-semibold text-lg lg:text-2xl text-gray-800">{{ totalInKindCount }}</div>
                </div>


            </div>

            <div class="flex justify-end items-center mr-3 my-1">
                <label (click)="showStats = !showStats" class="text-sm text-gray-900 bg-emerald-50 p-2 hover:text-emerald-700 rounded-lg px-3">{{!showStats ? 'View Stats ▼' : 'Hide Stats ▲'}}</label>
            </div>

            <!-- Table / list -->
            <div class="pt-2 lg:pt-6 pb-24">
                
                <!-- Table Controls -->
                <div class="flex flex-col lg:flex-row justify-between items-center p-4 space-y-3 lg:space-y-0 lg:space-x-4">

                    <!-- Search -->
                    <div class="w-full lg:w-1/3">
                        <input type="text" placeholder="Search records..." [(ngModel)]="filter.search" (input)="resetPage()" class="w-full border rounded-lg px-4 py-2 text-gray-700 focus:ring-2 focus:ring-emerald-500 outline-none" />
                    </div>

                    <div class="w-full flex items-center justify-between space-x-4">


                        <div class="w-44">
                            <app-select-input class="w-full" *ngIf="refreshSelect" id="organisation" [selectInputData]="{ items: ['All Types', 'Cash', 'In-Kind'], defaultValue: filter.type, placeholder: 'Donation Type', autoClose: true }" (selectionChanged)="onFilter('type', $event)"></app-select-input>
                        </div>

                        <!-- Actions Menu -->
                        <div class="relative">
                            
                            <button (click)="toggleMenu()" class="flex items-center bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-gray-700">
                                <span class="mr-2">Actions</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" ill="currentColor">
                                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.584l3.71-4.354a.75.75 0 111.14.976l-4.25 5a.75.75 0 01-1.14 0l-4.25-5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                                </svg>
                            </button>

                            <!-- Dropdown -->
                            <div *ngIf="menuOpen" class="absolute right-0 mt-2 w-44 bg-white border rounded-lg shadow-lg z-20">
                                <ul class="py-2 text-sm text-gray-700">
                                    
                                    <li>
                                        <button (click)="exportPDF()" class="block w-full text-center px-4 py-2 hover:bg-gray-100">Print
                                            PDF</button>
                                    </li>

                                    <li>
                                        <button (click)="exportCSV()" class="block w-full text-center px-4 py-2 hover:bg-gray-100">Export as
                                            CSV</button>
                                    </li>

                                </ul>
                            </div>

                        </div>

                    </div>

                </div>

                <div class="p-2 italic text-sm text-gray-500">Click column heading to sort by column</div>

                <div class="overflow-x-auto bg-white rounded-xl shadow">
                    
                    <table class="min-w-full divide-y divide-gray-100">
                        
                        <thead class="bg-gray-100">
                            <!-- <tr>
                                <th (click)="setSort('id')" class="cursor-pointer px-4 py-3 text-center text-xs font-medium text-gray-900">
                                    ID <span *ngIf="sortField === 'id'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                </th>
                                <th (click)="setSort('date')" class="cursor-pointer px-4 py-3 text-center text-xs font-medium text-gray-900">
                                    Date <span *ngIf="sortField === 'date'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                </th>
                                <th (click)="setSort('organisation')" class="cursor-pointer px-4 py-3 text-center text-xs font-medium text-gray-900">
                                    Organisation <span *ngIf="sortField === 'organisation'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                </th>
                                <th *ngIf="filter?.tableData === 'Projects'" (click)="setSort('projects')" class="cursor-pointer px-4 py-3 text-center text-xs font-medium text-gray-900">
                                    Projects <span *ngIf="sortField === 'projects'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                </th>
                                <th *ngIf="user?.user_role !== 'lecturer'" (click)="setSort('lecturer')" class="cursor-pointer px-4 py-3 text-center text-xs font-medium text-gray-900">
                                    lecturer<span *ngIf="sortField === 'lecturer'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                </th>
                                <th *ngIf="filter?.tableData === 'Beneficiaries'"(click)="setSort('beneficiary')" class="cursor-pointer px-4 py-3 text-center text-xs font-medium text-gray-900">
                                    Beneficiary<span *ngIf="sortField === 'beneficiary'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                </th>
                                <th (click)="setSort('donationType')" class="cursor-pointer px-4 py-3 text-center text-xs font-medium text-gray-900">
                                    Type <span *ngIf="sortField === 'donationType'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                </th>
                                <th (click)="setSort('amount')" class="cursor-pointer px-4 py-3 text-center text-xs font-medium text-gray-900">
                                    Amount <span *ngIf="sortField === 'amount'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                </th>
                                <th (click)="setSort('status')" class="cursor-pointer px-4 py-3 text-center text-xs font-medium text-gray-900">
                                    Status <span *ngIf="sortField === 'status'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                </th>
                            </tr> -->
                            <tr>
                                <th class="cursor-pointer px-4 py-2 text-center text-xs font-medium text-gray-900 space-y-1">
                                    <div (click)="setSort('id')" class="flex justify-center items-center">
                                        ID <span *ngIf="sortField === 'id'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                    </div>
                                    <input [(ngModel)]="columnFilters.id" placeholder="Search ID" class="px-3 py-1 flex rounded focus:outline focus:outline-emerald-600 w-full" />
                                </th>
                                <th class="cursor-pointer px-4 py-2 text-center text-xs font-medium text-gray-900 space-y-1">
                                    <div (click)="setSort('date')" class="flex justify-center items-center">
                                        Date <span *ngIf="sortField === 'date'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                    </div>
                                    <input [(ngModel)]="columnFilters.date" placeholder="Search Date" class="px-3 py-1 flex rounded focus:outline focus:outline-emerald-600 w-full" />
                                </th>
                                <th class="cursor-pointer px-4 py-2 text-center text-xs font-medium text-gray-900 space-y-1">
                                    <div (click)="setSort('organisation')" class="flex justify-center items-center">
                                        Organisation <span *ngIf="sortField === 'organisation'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                    </div>
                                    <input [(ngModel)]="columnFilters.organisation" placeholder="Search Organisation" class="px-3 py-1 flex rounded focus:outline focus:outline-emerald-600 w-full" />
                                </th>
                                <th *ngIf="filter?.tableData === 'Projects'"  class="cursor-pointer px-4 py-2 text-center text-xs font-medium text-gray-900 space-y-1">
                                    <div (click)="setSort('projects')" class="flex justify-center items-center">
                                        Projects <span *ngIf="sortField === 'projects'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                    </div>
                                    <input [(ngModel)]="columnFilters.projects" placeholder="Search Projects" class="px-3 py-1 flex rounded focus:outline focus:outline-emerald-600 w-full" />
                                </th>
                                <th *ngIf="user?.user_role !== 'lecturer'"  class="cursor-pointer px-4 py-2 text-center text-xs font-medium text-gray-900 space-y-1">
                                    <div (click)="setSort('projects')" class="flex justify-center items-center">
                                        lecturer <span *ngIf="sortField === 'lecturer'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                    </div>
                                    <input [(ngModel)]="columnFilters.lecturer" placeholder="Search lecturer" class="px-3 py-1 flex rounded focus:outline focus:outline-emerald-600 w-full" />
                                </th>
                                <th *ngIf="filter?.tableData === 'Beneficiaries'"class="cursor-pointer px-4 py-2 text-center text-xs font-medium text-gray-900 space-y-1">
                                    <div (click)="setSort('beneficiaries')" class="flex justify-center items-center">
                                        Beneficiary <span *ngIf="sortField === 'beneficiaries'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                    </div>
                                    <input [(ngModel)]="columnFilters.beneficiaries" placeholder="Search Beneficiary" class="px-3 py-1 flex rounded focus:outline focus:outline-emerald-600 w-full" />
                                </th>
                                <th class="cursor-pointer px-4 py-2 text-center text-xs font-medium text-gray-900 space-y-1">
                                    <div (click)="setSort('donationType')" class="flex justify-center items-center">
                                        Type <span *ngIf="sortField === 'donationType'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                    </div>
                                    <input [(ngModel)]="columnFilters.donationType" placeholder="Search Type" class="px-3 py-1 flex rounded focus:outline focus:outline-emerald-600 w-full" />
                                </th>
                                <th class="cursor-pointer px-4 py-2 text-center text-xs font-medium text-gray-900 space-y-1">
                                    <div (click)="setSort('amount')" class="flex justify-center items-center">
                                        Amount <span *ngIf="sortField === 'amount'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                    </div>
                                    <input [(ngModel)]="columnFilters.amount" placeholder="Search Amount" class="px-3 py-1 flex rounded focus:outline focus:outline-emerald-600 w-full" />
                                </th>
                                <th class="cursor-pointer px-4 py-2 text-center text-xs font-medium text-gray-900 space-y-1">
                                    <div (click)="setSort('status')" class="flex justify-center items-center">
                                        Status <span *ngIf="sortField === 'status'" class="ml-2"> {{ sortDirection === 'asc' ? '▲' : '▼' }} </span>
                                    </div>
                                    <input [(ngModel)]="columnFilters.status" placeholder="Search Status" class="px-3 py-1 flex rounded focus:outline focus:outline-emerald-600 w-full" />
                                </th>
                            </tr>
                        </thead>

                        <tbody class="divide-y divide-gray-100">
                            
                            <tr *ngFor="let d of pageItems">
                                <td class="px-4 py-3 text-sm text-gray-700">{{ d?.id }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600">{{ d?.date }}</td>
                                <td class="px-4 py-3 text-sm text-gray-700">{{ d?.organisation?.name }}</td>
                                <td *ngIf="filter?.tableData === 'Projects'" class="px-4 py-3 text-sm text-gray-700">{{ d?.project?.name ?? '-' }}</td>
                                <td *ngIf="user?.user_role !== 'lecturer'" class="px-4 py-3 text-sm text-gray-700">{{ d.isAnonymous ? 'Anonymous' : d?.lecturer?.first_name + ' ' + d?.lecturer?.last_name }}</td>
                                <td *ngIf="filter?.tableData === 'Beneficiaries'" class="px-4 py-3 text-sm text-gray-700">{{ d?.beneficiary }}</td>
                                <td class="px-4 py-3 text-sm text-center">
                                    <span class="inline-block px-2 py-1 text-center rounded-full text-xs font-medium" [ngClass]="{'bg-green-100 text-green-700': d?.donationType==='Cash','bg-yellow-100 text-yellow-700': d?.donationType==='In-Kind'}">{{d?.donationType}}</span>
                                </td>
                                <td class="px-4 py-3 text-sm text-center">{{ d?.donationType === 'Cash' ? formatCurrency(d?.amount) : '-' }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600">{{ d?.status }}</td>
                            </tr>

                            <tr *ngIf="filtered.length === 0">
                                <td colspan="8" class="px-4 py-6 text-center text-gray-700">No donations match the filters.
                                </td>
                            </tr>

                        </tbody>

                    </table>

                </div>

                <!-- pagination -->
                <div class="mt-3 flex items-center justify-between">
                    
                    <div class="text-sm text-gray-600">Showing {{ (page-1)*pageSize + 1 }} — {{ Math.min(page*pageSize, filtered.length) }} of {{ filtered.length }}</div>
                    
                    <div class="flex items-center gap-2">
                        <button (click)="prevPage()" [disabled]="page===1" class="px-3 py-1 rounded border disabled:opacity-50">Prev</button>
                        <div class="px-3 py-1 bg-white border rounded">{{ page }} / {{ totalPages }}</div>
                        <button (click)="nextPage()" [disabled]="page===totalPages" class="px-3 py-1 rounded border disabled:opacity-50">Next</button>
                    </div>

                </div>

            </div>

        </div>

    </div>

    <app-fab-btn [fabData]="fabData" class="lg:hidden" (clicked)="toggleFilters()"></app-fab-btn>


    <div *ngIf="showFilters" (click)="toggleFilters()" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-70 z-40 py-3">

        <div class="bg-white w-full max-w-lg pb-4 m-4 rounded-lg shadow-lg">

            <div class="text-gray-900" (click)="$event.stopPropagation()">

                <div class="flex justify-between items-center pt-3 px-4">
                    <div class="text-lg font-bold">Filters</div>
                    <div type="button" (click)="toggleFilters()" class="text-gray-600 text-xl px-3 py-1 rounded-full bg-gray-100 hover:bg-gray-200">&times;</div>
                </div>

                <div class="bg-white rounded-xl p-4 shadow">
            
                    <div class=" mx-3 items-center space-y-6">

                        <div>
                            <label class="block text-xs text-gray-600 mb-1">From</label>
                            <input type="date" [(ngModel)]="filter.startDate" (ngModelChange)="resetPage()" class="w-full p-2 border rounded-md" />
                        </div>

                        <div>
                            <label class="block text-xs text-gray-600 mb-1">To</label>
                            <input type="date" [(ngModel)]="filter.endDate" (ngModelChange)="resetPage()" class="w-full p-2 border rounded-md" />
                        </div>

                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Report On</label>
                            <app-select-input class="w-full" *ngIf="refreshSelect" id="tableData" [selectInputData]="{ items: ['All Donations','Beneficiaries', 'Organisations', 'Projects'], defaultValue: filter.tableData, placeholder: 'Filter By Organisation', autoClose: true }" (selectionChanged)="onFilter('tableData', $event)"></app-select-input>
                        </div>

                        <div *ngIf="filter?.tableData !== 'Projects'">
                            <label class="block text-xs text-gray-600 mb-1">Filter By Organisation</label>
                            <app-select-input class="w-full" *ngIf="refreshSelect" id="organisation" [selectInputData]="{ items: organisations, defaultValue: filter.organisation, placeholder: 'Filter By Organisation', autoClose: true }" (selectionChanged)="onFilter('organisation', $event)"></app-select-input>
                        </div>

                        <div *ngIf="filter?.tableData === 'Projects'">
                            <label class="block text-xs text-gray-600 mb-1">Filter By Project</label>
                            <app-select-input class="w-full" *ngIf="refreshSelect" id="projects" [selectInputData]="{ items: projects, defaultValue: filter.project, placeholder: 'Filter By Projects', autoClose: true }" (selectionChanged)="onFilter('project', $event)"></app-select-input>
                        </div>

                    </div>
                    
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-emerald-100 border-t px-8">
                    <button (click)="toggleFilters()" class="bg-red-50 text-red-500" class="bg-gray-50 px-4 py-2 rounded">Cancel</button>
                    <button (click)="handleFilters()" class="px-4 py-2 text-white rounded bg-emerald-700">Apply</button>
                </div>

            </div>

        </div>

    </div>